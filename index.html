<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººçŸ¥è¯†åº“</title>
    <meta name="description" content="åŸºäºCloudflareçš„ä¸ªäººçŸ¥è¯†åº“ç³»ç»Ÿ">
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a202c">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
    
    <style>
        :root {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --accent-color: #4299e1;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="light"] {
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background-color: var(--bg-secondary);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius);
        }

        .nav-links a:hover {
            color: var(--accent-color);
            background-color: var(--bg-tertiary);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: var(--bg-tertiary);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            padding: 2rem 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* å¡ç‰‡ç»„ä»¶ */
        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .form-textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #3182ce;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #38a169;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #dd6b20;
        }

        .btn-error {
            background-color: var(--error-color);
            color: white;
        }

        .btn-error:hover:not(:disabled) {
            background-color: #e53e3e;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-outline:hover:not(:disabled) {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* æ–‡ç« åˆ—è¡¨ */
        .article-list {
            display: grid;
            gap: 1.25rem;
        }

        .article-item {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .article-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border-left-color: var(--accent-color);
        }

        .article-title {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .article-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .article-content-preview {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .article-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tag {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
        }

        /* AI åŠ©æ‰‹é¢æ¿ */
        .ai-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 400px;
            max-height: 600px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }

        .ai-panel-header {
            padding: 1rem;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-panel-content {
            padding: 1rem;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 450px;
        }

        .ai-message {
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            max-width: 85%;
        }

        .ai-message.user {
            background-color: var(--accent-color);
            color: white;
            align-self: flex-end;
        }

        .ai-message.assistant {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            align-self: flex-start;
        }

        .ai-panel-input {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--bg-tertiary);
        }

        .ai-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 60px;
            height: 60px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-toggle:hover {
            transform: scale(1.05);
        }

        /* ç™»å½•é¡µé¢ */
        .auth-container {
            max-width: 400px;
            margin: 4rem auto;
            padding: 2rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: var(--bg-secondary);
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background-color: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .auth-tab.active {
            background-color: var(--accent-color);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* ç®¡ç†é¢æ¿ */
        .admin-panel {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 2rem;
        }

        .admin-section {
            margin-bottom: 2rem;
        }

        .user-list {
            display: grid;
            gap: 1rem;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--bg-primary);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--accent-color);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .user-email {
            font-weight: 500;
        }

        .user-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å·¥å…·ç±» */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }

        .flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .items-center {
            align-items: center;
        }

        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }

        .w-full {
            width: 100%;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 640px) {
            .nav-links {
                gap: 0.75rem;
            }
            
            .nav-links a {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .ai-panel {
                width: calc(100vw - 2rem);
                right: 1rem;
                bottom: 1rem;
            }
            
            .user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .user-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        /* æ–‡ç« è¯¦æƒ…é¡µ */
        .article-detail {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 2rem;
        }

        .article-detail-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .article-detail-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .article-detail-meta {
            display: flex;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .article-detail-content {
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .article-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--bg-tertiary);
        }

        /* é€šçŸ¥ç³»ç»Ÿ */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow);
            z-index: 1002;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 400px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--error-color);
        }

        .notification.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification.info {
            border-left: 4px solid var(--accent-color);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <span>ğŸ“š</span>
                    <span>çŸ¥è¯†åº“</span>
                </div>
                <div class="nav-links">
                    <a href="#home" class="nav-link" data-view="home">é¦–é¡µ</a>
                    <a href="#articles" class="nav-link" data-view="articles">æ–‡ç« </a>
                    <a href="#create" class="nav-link" data-view="create">å†™æ–‡ç« </a>
                    <div id="auth-links">
                        <a href="#login" class="nav-link" data-view="login">ç™»å½•</a>
                        <a href="#register" class="nav-link" data-view="register">æ³¨å†Œ</a>
                    </div>
                    <div id="user-menu" class="hidden">
                        <span id="username" class="mr-2"></span>
                        <a href="#logout" id="logout-btn" class="btn btn-outline btn-sm">é€€å‡º</a>
                    </div>
                    <button class="theme-toggle" id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        <div id="app-content">
            <!-- å†…å®¹å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- AI åŠ©æ‰‹ -->
    <button class="ai-toggle" id="ai-toggle" title="AIåŠ©æ‰‹">ğŸ¤–</button>
    <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-header">
            <span>DeepSeek AI åŠ©æ‰‹</span>
            <button onclick="closeAIPanel()" class="btn btn-outline btn-sm" style="color: white; border-color: rgba(255,255,255,0.3)">Ã—</button>
        </div>
        <div class="ai-panel-content" id="ai-conversation">
            <div class="ai-message assistant">
                æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„çŸ¥è¯†åº“AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
            </div>
        </div>
        <div class="ai-panel-input">
            <input type="text" id="ai-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." class="form-input">
            <button onclick="sendAIMessage()" class="btn btn-primary">å‘é€</button>
        </div>
    </div>

    <!-- é€šçŸ¥ç³»ç»Ÿ -->
    <div id="notification-container"></div>

    <script>
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const state = {
            currentUser: null,
            currentView: 'home',
            articles: [],
            currentArticle: null,
            categories: ['æŠ€æœ¯', 'ç”Ÿæ´»', 'å­¦ä¹ ', 'å·¥ä½œ', 'å…¶ä»–'],
            apiBaseUrl: '/api' // æ ¹æ®å®é™…éƒ¨ç½²è°ƒæ•´
        };

        // DOM å…ƒç´ å¼•ç”¨
        const elements = {
            appContent: document.getElementById('app-content'),
            authLinks: document.getElementById('auth-links'),
            userMenu: document.getElementById('user-menu'),
            username: document.getElementById('username'),
            themeToggle: document.getElementById('theme-toggle'),
            aiToggle: document.getElementById('ai-toggle'),
            aiPanel: document.getElementById('ai-panel'),
            aiInput: document.getElementById('ai-input'),
            aiConversation: document.getElementById('ai-conversation'),
            notificationContainer: document.getElementById('notification-container')
        };

        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
            `;
            
            elements.notificationContainer.appendChild(notification);
            
            // æ˜¾ç¤ºé€šçŸ¥
            setTimeout(() => notification.classList.add('show'), 100);
            
            // è‡ªåŠ¨éšè—
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
            
            return notification;
        }

        // å·¥å…·å‡½æ•°ï¼šAPI è°ƒç”¨
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };

            try {
                const response = await fetch(`${state.apiBaseUrl}${endpoint}`, {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                return data;
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                showNotification(error.message, 'error');
                throw error;
            }
        }

        // ä¸»é¢˜ç®¡ç†
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            showNotification(`å·²åˆ‡æ¢åˆ°${newTheme === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}æ¨¡å¼`, 'info', 2000);
        }

        // è·¯ç”±ç®¡ç†
        function initRouter() {
            window.addEventListener('hashchange', handleRoute);
            // åˆå§‹è·¯ç”±å¤„ç†
            handleRoute();
        }

        function handleRoute() {
            const hash = window.location.hash.substring(1) || 'home';
            state.currentView = hash;
            renderView();
            updateNavigation();
        }

        // æ›´æ–°å¯¼èˆªçŠ¶æ€
        function updateNavigation() {
            // æ›´æ–°å¯¼èˆªé“¾æ¥æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('data-view') === state.currentView) {
                    link.style.color = 'var(--accent-color)';
                } else {
                    link.style.color = '';
                }
            });

            // æ›´æ–°ç”¨æˆ·èœå•æ˜¾ç¤º
            if (state.currentUser) {
                elements.authLinks.classList.add('hidden');
                elements.userMenu.classList.remove('hidden');
                elements.username.textContent = state.currentUser.username;
            } else {
                elements.authLinks.classList.remove('hidden');
                elements.userMenu.classList.add('hidden');
            }
        }

        // è§†å›¾æ¸²æŸ“
        async function renderView() {
            const appContent = elements.appContent;
            
            switch (state.currentView) {
                case 'home':
                    appContent.innerHTML = await renderHomeView();
                    break;
                case 'articles':
                    appContent.innerHTML = await renderArticlesView();
                    break;
                case 'create':
                    appContent.innerHTML = await renderCreateView();
                    break;
                case 'article':
                    appContent.innerHTML = await renderArticleView();
                    break;
                case 'login':
                    appContent.innerHTML = await renderAuthView('login');
                    break;
                case 'register':
                    appContent.innerHTML = await renderAuthView('register');
                    break;
                case 'admin':
                    appContent.innerHTML = await renderAdminView();
                    break;
                case 'logout':
                    await handleLogout();
                    break;
                default:
                    appContent.innerHTML = '<div class="card"><h2>é¡µé¢æœªæ‰¾åˆ°</h2><p>æ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨ã€‚</p></div>';
            }
        }

        // æ¸²æŸ“é¦–é¡µ
        async function renderHomeView() {
            try {
                const data = await apiCall('/articles?limit=5');
                state.articles = data.articles || [];
                
                return `
                    <div class="main-content">
                        <div>
                            <div class="card">
                                <h2>æ¬¢è¿ä½¿ç”¨ä¸ªäººçŸ¥è¯†åº“</h2>
                                <p>åŸºäº Cloudflare Workers å’Œ DeepSeek AI æ„å»ºçš„çŸ¥è¯†ç®¡ç†ç³»ç»Ÿ</p>
                                <div class="mt-2">
                                    <button class="btn btn-primary" onclick="window.location.hash='#create'">å¼€å§‹å†™æ–‡ç« </button>
                                    <button class="btn btn-outline" onclick="window.location.hash='#articles'">æµè§ˆæ‰€æœ‰æ–‡ç« </button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3>æœ€æ–°æ–‡ç« </h3>
                                    <a href="#articles">æŸ¥çœ‹å…¨éƒ¨</a>
                                </div>
                                <div class="article-list">
                                    ${state.articles.length > 0 ? 
                                        state.articles.map(article => `
                                            <div class="article-item" onclick="viewArticle('${article.id}')">
                                                <h3 class="article-title">${article.title}</h3>
                                                <div class="article-meta">
                                                    <span>ä½œè€…: ${article.author_name}</span>
                                                    <span>åˆ†ç±»: ${article.category}</span>
                                                    <span>${new Date(article.created_at).toLocaleDateString()}</span>
                                                </div>
                                                <div class="article-content-preview">${article.content.substring(0, 200)}...</div>
                                                ${article.tags && article.tags.length > 0 ? `
                                                    <div class="article-tags">
                                                        ${article.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('') : 
                                        '<p class="text-center">æš‚æ— æ–‡ç« ï¼Œ<a href="#create" style="color: var(--accent-color);">å¼€å§‹åˆ›ä½œ</a>å§ï¼</p>'
                                    }
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="card">
                                <h3>åˆ†ç±»</h3>
                                <div class="mt-2">
                                    ${state.categories.map(category => `
                                        <div class="form-group">
                                            <a href="#articles?category=${category}" style="color: var(--accent-color);">${category}</a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>å¿«é€Ÿæ“ä½œ</h3>
                                <div class="mt-2 flex flex-col gap-1">
                                    <button class="btn btn-outline w-full" onclick="window.location.hash='#create'">å†™æ–°æ–‡ç« </button>
                                    ${state.currentUser ? `
                                        <button class="btn btn-outline w-full" onclick="window.location.hash='#admin'">ç®¡ç†åå°</button>
                                    ` : ''}
                                    <button class="btn btn-outline w-full" onclick="toggleAIPanel()">AIåŠ©æ‰‹</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="card">
                        <h2>é¦–é¡µ</h2>
                        <p>åŠ è½½æ–‡ç« æ—¶å‡ºé”™: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“æ–‡ç« åˆ—è¡¨é¡µ
        async function renderArticlesView() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get('category');
                const search = urlParams.get('search');
                
                let endpoint = '/articles';
                if (category || search) {
                    endpoint += '?';
                    if (category) endpoint += `category=${category}`;
                    if (search) endpoint += `${category ? '&' : ''}search=${search}`;
                }
                
                const data = await apiCall(endpoint);
                state.articles = data.articles || [];
                
                return `
                    <div class="main-content">
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h2>æ–‡ç« åˆ—è¡¨</h2>
                                    <div class="flex gap-1">
                                        <input type="text" id="search-input" placeholder="æœç´¢æ–‡ç« ..." class="form-input" style="width: 200px;" value="${search || ''}">
                                        <button class="btn btn-primary" onclick="searchArticles()">æœç´¢</button>
                                    </div>
                                </div>
                                
                                ${category ? `<p>ç­›é€‰åˆ†ç±»: <strong>${category}</strong> <a href="#articles" style="color: var(--accent-color); margin-left: 1rem;">æ¸…é™¤ç­›é€‰</a></p>` : ''}
                                
                                <div class="article-list mt-2">
                                    ${state.articles.length > 0 ? 
                                        state.articles.map(article => `
                                            <div class="article-item" onclick="viewArticle('${article.id}')">
                                                <h3 class="article-title">${article.title}</h3>
                                                <div class="article-meta">
                                                    <span>ä½œè€…: ${article.author_name}</span>
                                                    <span>åˆ†ç±»: ${article.category}</span>
                                                    <span>${new Date(article.created_at).toLocaleDateString()}</span>
                                                    ${!article.is_public ? '<span style="color: var(--warning-color);">ç§æœ‰</span>' : ''}
                                                </div>
                                                <div class="article-content-preview">${article.content.substring(0, 200)}...</div>
                                                ${article.tags && article.tags.length > 0 ? `
                                                    <div class="article-tags">
                                                        ${article.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('') : 
                                        '<p class="text-center">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« </p>'
                                    }
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="card">
                                <h3>åˆ†ç±»ç­›é€‰</h3>
                                <div class="mt-2">
                                    ${state.categories.map(category => `
                                        <div class="form-group">
                                            <a href="#articles?category=${category}" style="color: var(--accent-color);">${category}</a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="card">
                        <h2>æ–‡ç« åˆ—è¡¨</h2>
                        <p>åŠ è½½æ–‡ç« æ—¶å‡ºé”™: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æœç´¢æ–‡ç« 
        function searchArticles() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm) {
                window.location.hash = `#articles?search=${encodeURIComponent(searchTerm)}`;
            } else {
                window.location.hash = '#articles';
            }
        }

        // æ¸²æŸ“åˆ›å»ºæ–‡ç« é¡µ
        async function renderCreateView() {
            if (!state.currentUser) {
                window.location.hash = '#login';
                return '<div class="card"><p>è¯·å…ˆç™»å½•</p></div>';
            }
            
            return `
                <div class="card">
                    <h2>åˆ›å»ºæ–°æ–‡ç« </h2>
                    <form id="create-article-form">
                        <div class="form-group">
                            <label class="form-label" for="article-title">æ ‡é¢˜</label>
                            <input type="text" id="article-title" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="article-category">åˆ†ç±»</label>
                            <select id="article-category" class="form-select" required>
                                <option value="">é€‰æ‹©åˆ†ç±»</option>
                                ${state.categories.map(category => `
                                    <option value="${category}">${category}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="article-tags">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
                            <input type="text" id="article-tags" class="form-input" placeholder="ä¾‹å¦‚: JavaScript,ç¼–ç¨‹,æ•™ç¨‹">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="article-content">å†…å®¹</label>
                            <textarea id="article-content" class="form-textarea" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="article-is-public" checked>
                                <span style="margin-left: 0.5rem;">å…¬å¼€æ–‡ç« </span>
                            </label>
                        </div>
                        
                        <div class="form-group flex gap-1">
                            <button type="submit" class="btn btn-primary">å‘å¸ƒæ–‡ç« </button>
                            <button type="button" class="btn btn-outline" onclick="window.location.hash='#articles'">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                
                <div class="card mt-2">
                    <h3>AI å†™ä½œåŠ©æ‰‹</h3>
                    <div class="form-group">
                        <label class="form-label" for="ai-writing-prompt">å†™ä½œæç¤º</label>
                        <input type="text" id="ai-writing-prompt" class="form-input" placeholder="ä¾‹å¦‚: å†™ä¸€ç¯‡å…³äºCloudflare Workersçš„ç®€ä»‹">
                    </div>
                    <button class="btn btn-outline" onclick="generateWithAI()">AI ç”Ÿæˆå†…å®¹</button>
                </div>
            `;
        }

        // æ¸²æŸ“æ–‡ç« è¯¦æƒ…é¡µ
        async function renderArticleView() {
            const articleId = new URLSearchParams(window.location.search).get('id');
            
            if (!articleId) {
                return '<div class="card"><p>æ–‡ç« IDä¸å­˜åœ¨</p></div>';
            }
            
            try {
                const data = await apiCall(`/articles/${articleId}`);
                state.currentArticle = data.article;
                
                if (!state.currentArticle) {
                    return '<div class="card"><p>æ–‡ç« ä¸å­˜åœ¨</p></div>';
                }
                
                const isOwner = state.currentUser && state.currentUser.id === state.currentArticle.user_id;
                
                return `
                    <div class="article-detail">
                        <div class="article-detail-header">
                            <h1 class="article-detail-title">${state.currentArticle.title}</h1>
                            <div class="article-detail-meta">
                                <span>ä½œè€…: ${state.currentArticle.author_name}</span>
                                <span>åˆ†ç±»: ${state.currentArticle.category}</span>
                                <span>å‘å¸ƒæ—¶é—´: ${new Date(state.currentArticle.created_at).toLocaleString()}</span>
                                <span>æ›´æ–°æ—¶é—´: ${new Date(state.currentArticle.updated_at).toLocaleString()}</span>
                                ${!state.currentArticle.is_public ? '<span style="color: var(--warning-color);">ç§æœ‰æ–‡ç« </span>' : ''}
                            </div>
                            ${state.currentArticle.tags && state.currentArticle.tags.length > 0 ? `
                                <div class="article-tags mt-1">
                                    ${state.currentArticle.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="article-detail-content">
                            ${state.currentArticle.content.replace(/\n/g, '<br>')}
                        </div>
                        
                        ${isOwner ? `
                            <div class="article-actions">
                                <button class="btn btn-primary" onclick="editArticle('${state.currentArticle.id}')">ç¼–è¾‘</button>
                                <button class="btn btn-error" onclick="deleteArticle('${state.currentArticle.id}')">åˆ é™¤</button>
                                <button class="btn btn-outline" onclick="window.location.hash='#articles'">è¿”å›åˆ—è¡¨</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="card">
                        <h2>æ–‡ç« è¯¦æƒ…</h2>
                        <p>åŠ è½½æ–‡ç« æ—¶å‡ºé”™: ${error.message}</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“è®¤è¯é¡µé¢
        async function renderAuthView(type) {
            return `
                <div class="auth-container">
                    <div class="card">
                        <div class="auth-tabs">
                            <button class="auth-tab ${type === 'login' ? 'active' : ''}" onclick="switchAuthTab('login')">ç™»å½•</button>
                            <button class="auth-tab ${type === 'register' ? 'active' : ''}" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
                        </div>
                        
                        <form id="login-form" class="auth-form ${type === 'login' ? 'active' : ''}">
                            <div class="form-group">
                                <label class="form-label" for="login-email">é‚®ç®±</label>
                                <input type="email" id="login-email" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="login-password">å¯†ç </label>
                                <input type="password" id="login-password" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary w-full">ç™»å½•</button>
                            </div>
                        </form>
                        
                        <form id="register-form" class="auth-form ${type === 'register' ? 'active' : ''}">
                            <div class="form-group">
                                <label class="form-label" for="register-email">é‚®ç®±</label>
                                <input type="email" id="register-email" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="register-username">ç”¨æˆ·å</label>
                                <input type="text" id="register-username" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="register-password">å¯†ç </label>
                                <input type="password" id="register-password" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="register-confirm-password">ç¡®è®¤å¯†ç </label>
                                <input type="password" id="register-confirm-password" class="form-input" required>
                            </div>
                            
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary w-full">æ³¨å†Œ</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“ç®¡ç†é¡µé¢
        async function renderAdminView() {
            if (!state.currentUser) {
                window.location.hash = '#login';
                return '<div class="card"><p>è¯·å…ˆç™»å½•</p></div>';
            }
            
            try {
                // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
                const isAdmin = await checkAdminPermission();
                if (!isAdmin) {
                    return `
                        <div class="card">
                            <h2>ç®¡ç†åå°</h2>
                            <p>æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™è®¿é—®æ­¤é¡µé¢ã€‚</p>
                        </div>
                    `;
                }
                
                // è·å–å¾…å®¡æ ¸ç”¨æˆ·
                const usersData = await apiCall('/admin/pending-users');
                const pendingUsers = usersData.users || [];
                
                return `
                    <div class="admin-panel">
                        <h2>ç®¡ç†åå°</h2>
                        
                        <div class="admin-section">
                            <h3>ç”¨æˆ·å®¡æ ¸</h3>
                            ${pendingUsers.length > 0 ? `
                                <div class="user-list">
                                    ${pendingUsers.map(user => `
                                        <div class="user-item">
                                            <div class="user-info">
                                                <div class="user-email">${user.email}</div>
                                                <div class="user-meta">
                                                    ç”¨æˆ·å: ${user.username} | 
                                                    æ³¨å†Œæ—¶é—´: ${new Date(user.created_at).toLocaleString()}
                                                </div>
                                            </div>
                                            <div class="user-actions">
                                                <button class="btn btn-success btn-sm" onclick="approveUser('${user.id}', true)">é€šè¿‡</button>
                                                <button class="btn btn-error btn-sm" onclick="approveUser('${user.id}', false)">æ‹’ç»</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p>æš‚æ— å¾…å®¡æ ¸ç”¨æˆ·</p>'}
                        </div>
                        
                        <div class="admin-section">
                            <h3>æ•°æ®ç®¡ç†</h3>
                            <div class="flex gap-1">
                                <button class="btn btn-outline" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                                <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">å¯¼å…¥æ•°æ®</button>
                                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this.files[0])">
                            </div>
                        </div>
                        
                        <div class="admin-section">
                            <h3>ç³»ç»Ÿä¿¡æ¯</h3>
                            <p>çŸ¥è¯†åº“ç³»ç»Ÿç‰ˆæœ¬: 1.0.0</p>
                            <p>å½“å‰ç”¨æˆ·: ${state.currentUser.username}</p>
                            <p>AIæ¨¡å‹: DeepSeek</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                return `
                    <div class="card">
                        <h2>ç®¡ç†åå°</h2>
                        <p>åŠ è½½ç®¡ç†é¡µé¢æ—¶å‡ºé”™: ${error.message}</p>
                    </div>
                `;
            }
        }

        // åˆ‡æ¢è®¤è¯æ ‡ç­¾é¡µ
        function switchAuthTab(tab) {
            window.location.hash = `#${tab}`;
        }

        // æŸ¥çœ‹æ–‡ç« è¯¦æƒ…
        function viewArticle(articleId) {
            window.location.hash = `#article?id=${articleId}`;
        }

        // ç¼–è¾‘æ–‡ç« 
        function editArticle(articleId) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
            showNotification('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // åˆ é™¤æ–‡ç« 
        async function deleteArticle(articleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            try {
                await apiCall(`/articles/${articleId}`, { method: 'DELETE' });
                showNotification('æ–‡ç« å·²åˆ é™¤', 'success');
                window.location.hash = '#articles';
            } catch (error) {
                // é”™è¯¯å·²åœ¨apiCallä¸­å¤„ç†
            }
        }

        // è®¤è¯ç®¡ç†
        async function handleLogin(email, password) {
            try {
                const data = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                localStorage.setItem('token', data.token);
                state.currentUser = data.user;
                showNotification('ç™»å½•æˆåŠŸ', 'success');
                window.location.hash = 'home';
            } catch (error) {
                // é”™è¯¯å·²åœ¨apiCallä¸­å¤„ç†
            }
        }

        async function handleRegister(email, username, password, confirmPassword) {
            if (password !== confirmPassword) {
                showNotification('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            try {
                const data = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ email, username, password })
                });
                
                showNotification(data.message || 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸', 'success');
                window.location.hash = 'login';
            } catch (error) {
                // é”™è¯¯å·²åœ¨apiCallä¸­å¤„ç†
            }
        }

        async function handleLogout() {
            localStorage.removeItem('token');
            state.currentUser = null;
            showNotification('å·²é€€å‡ºç™»å½•', 'info');
            window.location.hash = 'home';
        }

        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        async function checkAdminPermission() {
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨ä¸€ä¸ªAPIæ¥éªŒè¯ç”¨æˆ·æƒé™
                // ç®€åŒ–å¤„ç†ï¼šå‡è®¾ç¬¬ä¸€ä¸ªç”¨æˆ·æ˜¯ç®¡ç†å‘˜
                return state.currentUser && state.currentUser.id === 'admin';
            } catch (error) {
                return false;
            }
        }

        // ç®¡ç†å‘˜åŠŸèƒ½
        async function approveUser(userId, approve) {
            try {
                await apiCall('/admin/approve-user', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        userId, 
                        action: approve ? 'approve' : 'reject' 
                    })
                });
                
                showNotification(`ç”¨æˆ·å·²${approve ? 'é€šè¿‡' : 'æ‹’ç»'}`, 'success');
                // åˆ·æ–°ç®¡ç†é¡µé¢
                window.location.hash = 'admin';
            } catch (error) {
                // é”™è¯¯å·²åœ¨apiCallä¸­å¤„ç†
            }
        }

        async function exportData() {
            try {
                const data = await apiCall('/admin/export');
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `knowledge-base-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                // é”™è¯¯å·²åœ¨apiCallä¸­å¤„ç†
            }
        }

        async function importData(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    await apiCall('/admin/import', {
                        method: 'POST',
                        body: JSON.stringify(importData)
                    });
                    showNotification('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                } catch (error) {
                    showNotification('å¯¼å…¥æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
            };
            reader.readAsText(file);
        }

        // AI åŠ©æ‰‹åŠŸèƒ½
        function toggleAIPanel() {
            if (!state.currentUser) {
                showNotification('è¯·å…ˆç™»å½•ä»¥ä½¿ç”¨AIåŠ©æ‰‹', 'warning');
                window.location.hash = 'login';
                return;
            }
            
            const panel = elements.aiPanel;
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        function closeAIPanel() {
            elements.aiPanel.style.display = 'none';
        }

        async function sendAIMessage() {
            const input = elements.aiInput;
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ·»åŠ åˆ°å¯¹è¯
            addAIMessage('user', message);
            input.value = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingMessage = addAIMessage('assistant', 'æ€è€ƒä¸­...', true);
            
            try {
                const response = await apiCall('/ai/generate', {
                    method: 'POST',
                    body: JSON.stringify({ prompt: message })
                });
                
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                loadingMessage.remove();
                
                // æ·»åŠ AIå›å¤
                addAIMessage('assistant', response.response);
            } catch (error) {
                // ç§»é™¤åŠ è½½æ¶ˆæ¯
                loadingMessage.remove();
                
                // æ·»åŠ é”™è¯¯æ¶ˆæ¯
                addAIMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }

        function addAIMessage(role, content, isTemp = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;
            messageDiv.textContent = content;
            
            if (isTemp) {
                messageDiv.id = 'temp-ai-message';
            }
            
            elements.aiConversation.appendChild(messageDiv);
            elements.aiConversation.scrollTop = elements.aiConversation.scrollHeight;
            
            return messageDiv;
        }

        // AI ç”Ÿæˆæ–‡ç« å†…å®¹
        async function generateWithAI() {
            const promptInput = document.getElementById('ai-writing-prompt');
            const contentTextarea = document.getElementById('article-content');
            
            const prompt = promptInput.value.trim();
            if (!prompt) {
                showNotification('è¯·è¾“å…¥å†™ä½œæç¤º', 'warning');
                return;
            }
            
            const button = document.querySelector('button[onclick="generateWithAI()"]');
            const originalText = button.textContent;
            button.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            button.disabled = true;
            
            try {
                const response = await apiCall('/ai/generate', {
                    method: 'POST',
                    body: JSON.stringify({ prompt })
                });
                
                contentTextarea.value = response.response;
                showNotification('AIå†…å®¹ç”ŸæˆæˆåŠŸ', 'success');
            } catch (error) {
                // é”™è¯¯å·²åœ¨apiCallä¸­å¤„ç†
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // æ–‡ç« è¡¨å•æäº¤
        async function handleArticleSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('article-title').value;
            const category = document.getElementById('article-category').value;
            const tags = document.getElementById('article-tags').value;
            const content = document.getElementById('article-content').value;
            const isPublic = document.getElementById('article-is-public').checked;
            
            const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            const button = event.target.querySelector('button[type="submit"]');
            const originalText = button.textContent;
            button.innerHTML = '<span class="loading"></span> å‘å¸ƒä¸­...';
            button.disabled = true;
            
            try {
                await apiCall('/articles', {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        content,
                        category,
                        tags: tagArray,
                        is_public: isPublic
                    })
                });
                
                showNotification('æ–‡ç« å‘å¸ƒæˆåŠŸ', 'success');
                window.location.hash = 'articles';
            } catch (error) {
                // é”™è¯¯å·²åœ¨apiCallä¸­å¤„ç†
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initRouter();
            
            // äº‹ä»¶ç›‘å¬å™¨
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.aiToggle.addEventListener('click', toggleAIPanel);
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (token) {
                verifyToken(token);
            }
            
            // å…¨å±€äº‹ä»¶å§”æ‰˜
            document.addEventListener('submit', function(event) {
                if (event.target.id === 'login-form') {
                    event.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    handleLogin(email, password);
                }
                
                if (event.target.id === 'register-form') {
                    event.preventDefault();
                    const email = document.getElementById('register-email').value;
                    const username = document.getElementById('register-username').value;
                    const password = document.getElementById('register-password').value;
                    const confirmPassword = document.getElementById('register-confirm-password').value;
                    handleRegister(email, username, password, confirmPassword);
                }
                
                if (event.target.id === 'create-article-form') {
                    handleArticleSubmit(event);
                }
            });
            
            // AIè¾“å…¥æ¡†å›è½¦å‘é€
            elements.aiInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    sendAIMessage();
                }
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­AIé¢æ¿
            document.addEventListener('click', function(event) {
                if (!elements.aiPanel.contains(event.target) && 
                    !elements.aiToggle.contains(event.target) && 
                    elements.aiPanel.style.display === 'flex') {
                    closeAIPanel();
                }
            });
        });

        // éªŒè¯token
        async function verifyToken(token) {
            try {
                const data = await apiCall('/auth/me');
                state.currentUser = data.user;
                updateNavigation();
            } catch (error) {
                // tokenæ— æ•ˆï¼Œæ¸…é™¤
                localStorage.removeItem('token');
            }
        }

        // PWA æœåŠ¡å·¥ä½œè€…æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>