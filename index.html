<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººçŸ¥è¯†åº“</title>
    <meta name="description" content="åŸºäºCloudflareçš„ä¸ªäººçŸ¥è¯†åº“ç³»ç»Ÿ">
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a202c">
    <link rel="icon" href="/icons/icon-192x192.png">
    
    <style>
        :root {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --accent-color: #4299e1;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
        }

        [data-theme="light"] {
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background-color: var(--bg-secondary);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            padding: 2rem 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* å¡ç‰‡ç»„ä»¶ */
        .card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 200px;
            resize: vertical;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        /* æ–‡ç« åˆ—è¡¨ */
        .article-list {
            display: grid;
            gap: 1rem;
        }

        .article-item {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .article-item:hover {
            transform: translateY(-2px);
        }

        .article-title {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .article-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .article-content-preview {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* AI åŠ©æ‰‹é¢æ¿ */
        .ai-panel {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 400px;
            max-height: 600px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .ai-panel-header {
            padding: 1rem;
            background-color: var(--accent-color);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .ai-panel-content {
            padding: 1rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        .ai-panel-input {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--bg-tertiary);
        }

        .ai-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 60px;
            height: 60px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }

        /* ç™»å½•é¡µé¢ */
        .auth-container {
            max-width: 400px;
            margin: 4rem auto;
            padding: 2rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background-color: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .auth-tab.active {
            background-color: var(--accent-color);
            color: white;
        }

        .hidden {
            display: none;
        }

        /* ç®¡ç†é¢æ¿ */
        .admin-panel {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 2rem;
        }

        .user-list {
            display: grid;
            gap: 1rem;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--bg-primary);
            border-radius: 4px;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <div class="logo">çŸ¥è¯†åº“</div>
                <div class="nav-links">
                    <a href="#home">é¦–é¡µ</a>
                    <a href="#articles">æ–‡ç« </a>
                    <a href="#create">å†™æ–‡ç« </a>
                    <div id="auth-links">
                        <a href="#login" id="login-link">ç™»å½•</a>
                        <a href="#register" id="register-link">æ³¨å†Œ</a>
                    </div>
                    <div id="user-menu" class="hidden">
                        <span id="username"></span>
                        <a href="#logout" id="logout-btn">é€€å‡º</a>
                    </div>
                    <button class="theme-toggle" id="theme-toggle">ğŸŒ“</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        <div id="app-content">
            <!-- å†…å®¹å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- AI åŠ©æ‰‹ -->
    <button class="ai-toggle" id="ai-toggle">AI</button>
    <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-header">
            <span>DeepSeek AI åŠ©æ‰‹</span>
            <button onclick="closeAIPanel()">Ã—</button>
        </div>
        <div class="ai-panel-content" id="ai-conversation">
            <!-- AIå¯¹è¯å†…å®¹ -->
        </div>
        <div class="ai-panel-input">
            <input type="text" id="ai-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." class="form-input">
            <button onclick="sendAIMessage()" class="btn btn-primary">å‘é€</button>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const state = {
            currentUser: null,
            currentView: 'home',
            articles: [],
            currentArticle: null
        };

        // ä¸»é¢˜ç®¡ç†
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // è·¯ç”±ç®¡ç†
        function initRouter() {
            window.addEventListener('hashchange', handleRoute);
            handleRoute();
        }

        function handleRoute() {
            const hash = window.location.hash.substring(1) || 'home';
            state.currentView = hash;
            renderView();
        }

        // è§†å›¾æ¸²æŸ“
        async function renderView() {
            const appContent = document.getElementById('app-content');
            
            switch (state.currentView) {
                case 'home':
                    appContent.innerHTML = await renderHomeView();
                    break;
                case 'articles':
                    appContent.innerHTML = await renderArticlesView();
                    break;
                case 'create':
                    appContent.innerHTML = await renderCreateView();
                    break;
                case 'login':
                    appContent.innerHTML = await renderAuthView('login');
                    break;
                case 'register':
                    appContent.innerHTML = await renderAuthView('register');
                    break;
                case 'admin':
                    appContent.innerHTML = await renderAdminView();
                    break;
                default:
                    appContent.innerHTML = '<div class="card"><h2>é¡µé¢æœªæ‰¾åˆ°</h2></div>';
            }
            
            updateNavigation();
        }

        // æ¸²æŸ“é¦–é¡µ
        async function renderHomeView() {
            const articles = await fetchArticles();
            return `
                <div class="main-content">
                    <div>
                        <div class="card">
                            <h2>æ¬¢è¿ä½¿ç”¨ä¸ªäººçŸ¥è¯†åº“</h2>
                            <p>åŸºäº Cloudflare Workers å’Œ DeepSeek AI æ„å»ºçš„çŸ¥è¯†ç®¡ç†ç³»ç»Ÿ</p>
                        </div>
                        <div class="article-list">
                            ${articles.map(article => `
                                <div class="article-item" onclick="viewArticle('${article.id}')">
                                    <h3 class="article-title">${article.title}</h3>
                                    <div class="article-meta">
                                        ä½œè€…: ${article.author_name} | åˆ†ç±»: ${article.category} | ${new Date(article.created_at).toLocaleDateString()}
                                    </div>
                                    <div class="article-content-preview">${article.content.substring(0, 200)}...</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <div class="card">
                            <h3>åˆ†ç±»</h3>
                            <!-- åˆ†ç±»åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>
            `;
        }

        // è®¤è¯ç®¡ç†
        async function login(email, password) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    state.currentUser = data.user;
                    window.location.hash = 'home';
                } else {
                    alert(data.error);
                }
            } catch (error) {
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        async function register(email, username, password) {
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password })
                });
                
                const data = await response.json();
                alert(data.message || data.error);
                
                if (response.ok) {
                    window.location.hash = 'login';
                }
            } catch (error) {
                alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            }
        }

        // AI åŠ©æ‰‹åŠŸèƒ½
        function toggleAIPanel() {
            const panel = document.getElementById('ai-panel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        function closeAIPanel() {
            document.getElementById('ai-panel').style.display = 'none';
        }

        async function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ·»åŠ åˆ°å¯¹è¯
            addAIMessage('user', message);
            input.value = '';
            
            try {
                const response = await fetch('/api/ai/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ prompt: message })
                });
                
                const data = await response.json();
                if (response.ok) {
                    addAIMessage('assistant', data.response);
                } else {
                    addAIMessage('assistant', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ã€‚');
                }
            } catch (error) {
                addAIMessage('assistant', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }

        function addAIMessage(role, content) {
            const conversation = document.getElementById('ai-conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;
            messageDiv.textContent = content;
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        // PWA æœåŠ¡å·¥ä½œè€…æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => console.log('SW registered'))
                .catch(error => console.log('SW registration failed'));
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initRouter();
            
            // äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('ai-toggle').addEventListener('click', toggleAIPanel);
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const token = localStorage.getItem('token');
            if (token) {
                verifyToken(token);
            }
        });

        // æ›´å¤šJavaScriptå‡½æ•°...
        // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œåªå±•ç¤ºäº†éƒ¨åˆ†æ ¸å¿ƒä»£ç 
        // å®Œæ•´ä»£ç éœ€è¦å®ç°æ‰€æœ‰è§†å›¾æ¸²æŸ“ã€APIè°ƒç”¨ç­‰åŠŸèƒ½
    </script>
</body>
</html>