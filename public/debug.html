<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“è°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: system-ui; background: #1a1a1a; color: white; padding: 2rem; }
        .debug-section { background: #2d2d2d; padding: 1rem; margin: 1rem 0; border-radius: 0.5rem; }
        button { background: #4f46e5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; margin: 0.5rem; }
        pre { background: #1a1a1a; padding: 1rem; border-radius: 0.5rem; overflow: auto; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
    </style>
</head>
<body>
    <h1>çŸ¥è¯†åº“è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h3>1. æµ‹è¯•APIç«¯ç‚¹</h3>
        <button onclick="testEndpoint('/api/categories')">æµ‹è¯•åˆ†ç±»API</button>
        <button onclick="testEndpoint('/api/tags')">æµ‹è¯•æ ‡ç­¾API</button>
        <button onclick="testEndpoint('/api/articles')">æµ‹è¯•æ–‡ç« API</button>
        <div id="apiResults"></div>
    </div>

    <div class="debug-section">
        <h3>2. æ£€æŸ¥ç¯å¢ƒ</h3>
        <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
        <div id="environmentResults"></div>
    </div>

    <div class="debug-section">
        <h3>3. æ•°æ®åº“æµ‹è¯•</h3>
        <button onclick="testDatabase()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
        <div id="databaseResults"></div>
    </div>

    <div class="debug-section">
        <h3>4. åˆ†ç±»æ•°æ®</h3>
        <button onclick="loadAndDisplayCategories()">åŠ è½½å¹¶æ˜¾ç¤ºåˆ†ç±»</button>
        <div id="categoriesResults"></div>
    </div>

    <script>
        async function testEndpoint(endpoint) {
            const results = document.getElementById('apiResults');
            results.innerHTML = `<p>æµ‹è¯• ${endpoint} ...</p>`;
            
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                
                results.innerHTML += `
                    <div class="success">
                        <strong>${endpoint}:</strong> çŠ¶æ€ ${response.status}
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                results.innerHTML += `
                    <div class="error">
                        <strong>${endpoint}:</strong> é”™è¯¯ - ${error.message}
                    </div>
                `;
            }
        }

        function checkEnvironment() {
            const results = document.getElementById('environmentResults');
            results.innerHTML = `
                <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                <p><strong>Online:</strong> ${navigator.onLine}</p>
                <p><strong>Cookies Enabled:</strong> ${navigator.cookieEnabled}</p>
                <p><strong>Language:</strong> ${navigator.language}</p>
            `;
        }

        async function testDatabase() {
            const results = document.getElementById('databaseResults');
            results.innerHTML = `<p>æµ‹è¯•æ•°æ®åº“è¿æ¥...</p>`;
            
            try {
                // æµ‹è¯•åŸºæœ¬API
                const response = await fetch('/api/categories');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                results.innerHTML += `
                    <div class="success">
                        <p>æ•°æ®åº“è¿æ¥æˆåŠŸï¼</p>
                        <p>è¿”å›æ•°æ®é•¿åº¦: ${Array.isArray(data) ? data.length : 'éæ•°ç»„'}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                results.innerHTML += `
                    <div class="error">
                        <p>æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}</p>
                        <p>è¯·æ£€æŸ¥ï¼š</p>
                        <ul>
                            <li>D1æ•°æ®åº“æ˜¯å¦å·²åˆ›å»º</li>
                            <li>æ•°æ®åº“ç»‘å®šæ˜¯å¦æ­£ç¡®</li>
                            <li>æ•°æ®è¡¨æ˜¯å¦å·²åˆå§‹åŒ–</li>
                        </ul>
                    </div>
                `;
            }
        }

        async function loadAndDisplayCategories() {
            const results = document.getElementById('categoriesResults');
            results.innerHTML = `<p>åŠ è½½åˆ†ç±»æ•°æ®...</p>`;
            
            try {
                const response = await fetch('/api/categories');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const categories = await response.json();
                
                results.innerHTML += `
                    <div class="success">
                        <p>æˆåŠŸåŠ è½½ ${Array.isArray(categories) ? categories.length : 0} ä¸ªåˆ†ç±»</p>
                        <h4>åˆ†ç±»ç»“æ„:</h4>
                        <pre>${JSON.stringify(categories, null, 2)}</pre>
                    </div>
                `;
                
                // æ˜¾ç¤ºæ ‘å½¢ç»“æ„
                if (Array.isArray(categories) && categories.length > 0) {
                    const tree = buildCategoryTree(categories);
                    results.innerHTML += `<h4>æ ‘å½¢æ˜¾ç¤º:</h4><div>${tree}</div>`;
                }
            } catch (error) {
                results.innerHTML += `
                    <div class="error">
                        <p>åŠ è½½åˆ†ç±»å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }

        function buildCategoryTree(categories, parentId = null, level = 0) {
            let html = '';
            const children = categories.filter(cat => cat.parent_id === parentId);
            
            children.forEach(category => {
                const padding = '  '.repeat(level);
                html += `<div style="margin-left: ${level * 20}px">${padding}ğŸ“ ${category.name} (ID: ${category.id})</div>`;
                
                if (category.children && category.children.length > 0) {
                    html += buildCategoryTree(categories, category.id, level + 1);
                } else {
                    const subChildren = categories.filter(cat => cat.parent_id === category.id);
                    if (subChildren.length > 0) {
                        html += buildCategoryTree(categories, category.id, level + 1);
                    }
                }
            });
            
            return html;
        }
    </script>
</body>
</html>
