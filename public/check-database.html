<!DOCTYPE html>
<html>
<head>
    <title>æ•°æ®åº“æ£€æŸ¥</title>
    <style>
        body { font-family: system-ui; padding: 2rem; background: #1a1a1a; color: white; }
        button { background: #4f46e5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; margin: 0.5rem; }
        pre { background: #2d2d2d; padding: 1rem; border-radius: 0.5rem; overflow: auto; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
    </style>
</head>
<body>
    <h1>æ•°æ®åº“çŠ¶æ€æ£€æŸ¥</h1>
    
    <button onclick="checkTables()">æ£€æŸ¥æ•°æ®è¡¨</button>
    <button onclick="initDatabase()">åˆå§‹åŒ–æ•°æ®åº“</button>
    <button onclick="addSampleData()">æ·»åŠ ç¤ºä¾‹æ•°æ®</button>
    
    <div id="results"></div>

    <script>
        async function checkTables() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>æ£€æŸ¥æ•°æ®è¡¨...</p>';
            
            try {
                // æ£€æŸ¥åˆ†ç±»è¡¨
                const categoriesResponse = await fetch('/api/categories');
                const categories = await categoriesResponse.json();
                
                let html = '<h3>æ•°æ®è¡¨çŠ¶æ€:</h3>';
                
                if (Array.isArray(categories)) {
                    html += `<p class="success">âœ… åˆ†ç±»è¡¨æ­£å¸¸ (${categories.length} ä¸ªåˆ†ç±»)</p>`;
                } else {
                    html += `<p class="error">âŒ åˆ†ç±»è¡¨å¼‚å¸¸: ${categories.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
                
                // æ£€æŸ¥æ–‡ç« è¡¨
                try {
                    const articlesResponse = await fetch('/api/articles');
                    const articles = await articlesResponse.json();
                    html += `<p class="success">âœ… æ–‡ç« è¡¨æ­£å¸¸ (${Array.isArray(articles) ? articles.length : 0} ç¯‡æ–‡ç« )</p>`;
                } catch (e) {
                    html += `<p class="error">âŒ æ–‡ç« è¡¨å¼‚å¸¸: ${e.message}</p>`;
                }
                
                results.innerHTML += html;
            } catch (error) {
                results.innerHTML += `<p class="error">æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
            }
        }

        async function initDatabase() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>åˆå§‹åŒ–æ•°æ®åº“...</p>';
            
            const sql = `
                -- åˆ›å»ºåˆ†ç±»è¡¨ï¼ˆæ”¯æŒå¤šçº§ï¼‰
                CREATE TABLE IF NOT EXISTS categories (
                  id INTEGER PRIMARY KEY AUTOINCREMENT,
                  name TEXT NOT NULL,
                  parent_id INTEGER,
                  sort_order INTEGER DEFAULT 0,
                  FOREIGN KEY (parent_id) REFERENCES categories (id)
                );

                -- åˆ›å»ºæ–‡ç« è¡¨
                CREATE TABLE IF NOT EXISTS articles (
                  id INTEGER PRIMARY KEY AUTOINCREMENT,
                  title TEXT NOT NULL,
                  content TEXT NOT NULL,
                  category_id INTEGER NOT NULL,
                  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                  FOREIGN KEY (category_id) REFERENCES categories (id)
                );

                -- åˆ›å»ºæ ‡ç­¾è¡¨
                CREATE TABLE IF NOT EXISTS tags (
                  id INTEGER PRIMARY KEY AUTOINCREMENT,
                  name TEXT NOT NULL UNIQUE
                );

                -- åˆ›å»ºæ–‡ç« -æ ‡ç­¾å…³è”è¡¨
                CREATE TABLE IF NOT EXISTS article_tags (
                  article_id INTEGER,
                  tag_id INTEGER,
                  PRIMARY KEY (article_id, tag_id),
                  FOREIGN KEY (article_id) REFERENCES articles (id) ON DELETE CASCADE,
                  FOREIGN KEY (tag_id) REFERENCES tags (id) ON DELETE CASCADE
                );
            `;
            
            try {
                // è¿™é‡Œéœ€è¦ä¸€ä¸ªæ‰§è¡ŒSQLçš„APIç«¯ç‚¹
                const response = await fetch('/api/execute-sql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });
                
                if (response.ok) {
                    results.innerHTML += '<p class="success">âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ</p>';
                } else {
                    const error = await response.json();
                    results.innerHTML += `<p class="error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
            } catch (error) {
                results.innerHTML += `<p class="error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</p>`;
                results.innerHTML += `
                    <p>è¯·æ‰‹åŠ¨åœ¨Cloudflare D1æ•°æ®åº“ä¸­æ‰§è¡Œä»¥ä¸‹SQL:</p>
                    <pre>${sql}</pre>
                `;
            }
        }

        async function addSampleData() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>æ·»åŠ ç¤ºä¾‹æ•°æ®...</p>';
            
            const sampleData = {
                categories: [
                    { name: 'æŠ€æœ¯æ–‡æ¡£', parent_id: null, sort_order: 1 },
                    { name: 'å­¦ä¹ ç¬”è®°', parent_id: null, sort_order: 2 },
                    { name: 'å‰ç«¯å¼€å‘', parent_id: 1, sort_order: 1 },
                    { name: 'åç«¯å¼€å‘', parent_id: 1, sort_order: 2 }
                ]
            };
            
            try {
                for (const category of sampleData.categories) {
                    const response = await fetch('/api/categories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(category)
                    });
                    
                    if (response.ok) {
                        results.innerHTML += `<p class="success">âœ… æ·»åŠ åˆ†ç±»: ${category.name}</p>`;
                    } else {
                        const error = await response.json();
                        results.innerHTML += `<p class="error">âŒ æ·»åŠ åˆ†ç±»å¤±è´¥ ${category.name}: ${error.error}</p>`;
                    }
                }
                
                results.innerHTML += '<p class="success">ğŸ‰ ç¤ºä¾‹æ•°æ®æ·»åŠ å®Œæˆ</p>';
            } catch (error) {
                results.innerHTML += `<p class="error">âŒ æ·»åŠ ç¤ºä¾‹æ•°æ®å¤±è´¥: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
